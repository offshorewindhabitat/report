---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Results

```{r setup}
librarian::shelf(
  devtools, dplyr, DT, fs, glue, here, htmltools, leaflet, leaflet.extras,
  yogevherz/plotme, purrr, readr, sf, stringr, 
  tibble, tidyr, 
  quiet = T)
load_all("~/Github/ecoquants/offhabr")
options(readr.show_col_types = F)

con <- oh_con() # dbDisconnect(con, shutdown=T)

# tbl(con, "lyrs") |>
#   filter(is.na(aphia_id), is_ds_prime) |> 
#   pull(lyr_key)
#  [1] "vg"              "sm"              "ve"             
#  [4] "er_web_rescaled" "er_web"          "er_web_rescaled"
#  [7] "sa_web"          "sa_web_rescaled" "score_v1_web"   
# [10] "sm_web"          "sm_web_rescaled" "sp_web"         
# [13] "sp_web_rescaled" "ve_web"          "ve_web_rescaled"
# [16] "vg_web"          "vg_web_rescaled"
```

## Spatial

```{r}
z_csv <- here("../offhab-scripts/data/zonal_zones.csv")

f_z <- oh_zones_s1k |> 
  filter(zone_version == 1) |> 
  left_join(
    read_csv(z_csv) |> 
      mutate(across(where(is.numeric), round, 1)), 
    by = c("zone_id" = "zone_id_v1"))
```

::: {.panel-tabset}

### Score

::: {.panel-tabset}

#### Pixel Value

```{r pixel_score}
lyr_key   <- "score_v1_web"
lyr_title <- "Score"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_score}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::

### Species Richness

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_sp}
lyr_key   <- "sp_web"
lyr_title <- "# Taxa Present"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_sp}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::


### Species Abundance

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_sa}
lyr_key   <- "sa_web"
lyr_title <- "Sum of Relative Abundance"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_sa}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::

### Extinction Risk

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_er}
lyr_key   <- "er_web"
lyr_title <- "Extinction Risk"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_er}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::

### Primary Productivity

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_vg}
lyr_key   <- "vg_web"
lyr_title <- "Primary Productivity"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

- TODO: units above (like mg C / L) and other layers

#### Zone Average

```{r zone_vg}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::

### Hydrothermal Vents

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_ve}
lyr_key   <- "ve_web"
lyr_title <- "Hydrothermal Vents"

load_all("~/Github/ecoquants/offhabr")

d_rng <- tbl(con, "lyrs") |>
    filter(lyr_key == !!lyr_key) |>
    select(val_min, val_max) |>
    collect()

oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_ve}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::

### Seamounts

::::: {.panel-tabset}

#### Pixel Value

```{r pixel_sm}
lyr_key   <- "sm_web"
lyr_title <- "Seamounts"
oh_map_cog_lyr(lyr_key, lyr_title, con=con)
```

#### Zone Average

```{r zone_sm}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = all_of(lyr_key),
    fld_id  = zone_name,
    str_val = lyr_title,
    str_id  = "Zone")
```

:::::

:::

## Taxa

::: {.panel-tabset}

### All Taxa in Study Area

::::: {.panel-tabset}

#### Treemap

```{r all_taxa_treemap}
d_taxa <- tbl(con, "lyrs") |> 
  filter(
    !is.na(aphia_id),
    is_ds_prime) |> 
  select(aphia_id) |> 
  left_join(
    tbl(con, "taxa_wm") |>
      select(
        aphia_id, kingdom, phylum, class, 
        order, family, genus, scientificname),
    by = "aphia_id") |> 
  #select(-aphia_id) |> 
  mutate(
    n = 1) |> 
  arrange(
    kingdom, phylum, class, 
    order, family, genus, scientificname) |> 
  collect()
# check no duplicates and has all info
stopifnot(
  sum(duplicated(d_taxa$scientificname)) == 0,
  sum(is.na(d_taxa$kingdom))       == 0)
n_taxa <- nrow(d_taxa) # 10,061

# TODO: add link to shiny map, which should zoom to extent and display datasets

d_taxa |>
  select(-aphia_id) |> 
  count_to_treemap()

# TODO: add vernacular names, so easily searchable / understandable
```

- Number of taxa: `r n_taxa`

#### Table

```{r all_taxa_tbl}
d_taxa |>
  rowwise() |>
  mutate(
    taxa_hierarchy = c(
      kingdom, phylum, class, order,family,scientificname) |>  na.omit() |> 
      paste(collapse = " > "),
    taxa_link = glue(
      "<a
        target = _blank
        href   = 'https://shiny.offshorewindhabitat.info/sp_map/?aphia_id={aphia_id}'>
      {taxa_hierarchy}
      </a>")) |> 
  select(
    `Taxa: Kingdom > Phylum > Class > Order > Family > Genus species (common name)` = taxa_link) |>     
  datatable(escape = F)
```

:::::

### Taxa with Extinction Risk

::::: {.panel-tabset}

#### Treemap

```{r er_taxa_treemap}
er_csv <- here("../offhab-scripts/data/er.csv")

d_er <- read_csv(er_csv) |> 
  mutate(
    n           = 1,
    rl_category = recode(
      category,
      NT = "1. Near Threatened",
      VU = "2. Vulnerable",
      EN = "3. Endangered",
      CR = "4. Critically Endangered")) |> 
  arrange(desc(rl_category), kingdom, class, order, family, genus, scientificname)

d_er_tm <- d_er |>
  select(
    rl_category, kingdom, class, order, family, genus, scientificname, n)

d_er_tm |>
  count_to_treemap()
```

#### Table

```{r er_taxa_tbl}
d_er |>
  rowwise() |>
  mutate(
    taxa_hierarchy = c(
      kingdom, phylum, class, order,family, scientificname) |> na.omit() |> 
      paste(collapse = " > "),
    taxa_link = glue(
      "<a
        target = _blank
        href   = 'https://shiny.offshorewindhabitat.info/sp_map/?aphia_id={aphia_id}'>
      {taxa_hierarchy}
      </a>")) |> 
  select(
    `RedList Category` = rl_category, 
    `Taxa: Kingdom > Phylum > Class > Order > Family > Genus species (common name)` = taxa_link) |>     
  datatable(escape = F)
```

```{r er_taxa_summary}
table(d_er$rl_category)
```

:::::

:::

## Zones with Blocks

When zooming into the blocks in a zone, we look at deviation from the average score in the zone. 

```{r}
# offhabr::oh_blocks |> 
#   st_drop_geometry() |> 
#   filter(zone_version == 1) |> 
#   pull(zone_key) |> 
#   table()
# cec  cgm  mda  noa  noc  soa  soc  wao  wgm 
#  16   33 2165  342  237  801  673  753   96
zone_keys  <- oh_blocks |> 
  filter(zone_version == 1) |>  
  pull(zone_key) |> 
  unique()

# arrange in order from NW Pacific to GoMex to NE
# oh_zones_s1k |>
#   st_drop_geometry() |> 
#   filter(
#     zone_version == 1,
#     zone_key %in% zone_keys) |> 
#   arrange(zone_name) |> 
#   select(zone_name, zone_key)
# wao, noc, cec, soc, wgm, cgm, soa, mda, noa
m <- oh_map_zone_score_dev("wao")
```

::: {.panel-tabset}

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("noc")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("cec")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("soc")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("wgm")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("cgm")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("soa")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("mda")
```

### `r attr(m, "zone_name")`

```{r}
m
```

```{r}
m <- oh_map_zone_score_dev("noa")
```

### `r attr(m, "zone_name")`

```{r}
m
```

:::

```{r dbDisconnect}
dbDisconnect(con, shutdown=T)
```

