---
title: "Preliminary Results"
execute:
  echo: false
  warning: false
editor_options: 
  chunk_output_type: console
---

```{r setup}
librarian::shelf(
  devtools, dplyr, fs, glue, htmltools, leaflet, 
  yogevherz/plotme, purrr, readr, sf, stringr, 
  tibble, tidyr, 
  quiet = T)
load_all("~/Github/ecoquants/offhabr")
```

## Zones across U.S. (lower 48) Federal Waters

```{r}
con <- oh_con()

d_z <- tbl(con, "lyr_zone_stats") |> 
  filter(
    ds_key != "oa") |> 
  group_by(zone_id) |> 
  summarize(
    n_spp   = n(),
    res_avg = mean(mean, na.rm=T)) |> 
  collect()
  
f_z <- oh_zones_s1k |> 
  filter(zone_version == 1) |> 
  left_join(
    d_z, by = "zone_id")
```

::: {.panel-tabset}

## Species Presence

```{r}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = n_spp,
    fld_id  = zone_name,
    str_val = "# of species",
    str_id  = "Zone")
```

## Species Abundance

```{r}
oh_map() |> 
  oh_add_ply(
    ply     = f_z,
    fld_val = res_avg,
    fld_id  = zone_name,
    str_val = "% Habitat",
    str_id  = "Zone")
```

<!-- 
## Extinction Risk
Average extinction risk.
-->

:::

## Species Composition for Study Area

```{r}
d_z_spp <- tbl(con, "lyr_zone_stats") |> 
  filter(
    ds_key != "oa") |> 
  group_by(zone_id, aphia_id) |> 
  summarize(
    n_ds = n(), .groups = "drop") |> 
  left_join(
    tbl(con, "taxa_wm") |> 
      select(
        aphia_id, kingdom, class, order, family, genus, scientificname), 
    by = "aphia_id") |> 
  collect()

d_taxa <- d_z_spp |> 
  # filter(zone_id == 9) |> zone_name == "Southern California"
  distinct(
    kingdom, class, order, family, genus, scientificname) |> 
  mutate(
    n = 1) |> 
  group_by(
    kingdom, class, order, family) |> 
  summarize(
    n = sum(n),
    .groups = "drop")
  
d_taxa |>
  count_to_treemap()
```

## Block relative to Zones

...

